<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Canvas Image Upload</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        /* ギャラリーのスタイル */
        #gallery {
            display: flex;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        .gallery-item {
            text-align: center;
            margin: 10px;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 10px;
            width: 150px;
        }
        #gallery img {
            width: 100px;
            height: 100px;
            border-radius: 8px;
            object-fit: cover;
        }
        .description {
            margin-top: 10px;
            font-size: 12px;
            color: #555;
        }
    </style>
</head>
<body>
    <video id="camera" autoplay></video><br>
    <img id="img" style="max-width:100%;"><br>
    
    <canvas id="myCanvas" style="display:none"></canvas><br>
    <input type="text" id="txt" value="植物の名前と季節、地域、豆知識を一文ずつ改行して教えて" size=50>
    <button id="start">send</button>
    <button id="save">Save Image</button>
    
    <div id="gallery"></div> <!-- ギャラリー表示用のセクション -->
    <div id="answer">返信内容</div>
    
<script>
    // 初期設定
    var canvas = document.getElementById('myCanvas');
    var ctx = canvas.getContext('2d');
    var video = document.getElementById('camera');
    var imageData = '';

    $(document).ready(function() {
        /////// 以下、Webカメラを取り扱う処理
        video.setAttribute("width", 320);
        video.setAttribute("height", 240);

        //カメラが起動できたかのフラグ
        var localMediaStream = null;
        
        //カメラ使えるかチェック
        var hasGetUserMedia = function() {
            return (navigator.getUserMedia || navigator.webkitGetUserMedia ||
                    navigator.mozGetUserMedia || navigator.msGetUserMedia);
        };

        //エラー
        var onFailSoHard = function(e) {
            console.log('カメラを利用できません!', e);
            alert("カメラを利用できません! " + e);
        };

        if (!hasGetUserMedia()) {
            alert("Unsupported browser.");
        } else {
            window.URL = window.URL || window.webkitURL;
            navigator.getUserMedia = navigator.getUserMedia ||
                                     navigator.webkitGetUserMedia || navigator.mozGetUserMedia ||
                                     navigator.msGetUserMedia;
            navigator.getUserMedia({ video: true }, function(stream) {
                video.srcObject = stream;
                localMediaStream = stream;
            }, onFailSoHard);
        }
    });

    // ボタンがクリックされた時の処理
    $('#start').on('click', function() {
        // videoの縦幅横幅を取得
        var w = video.offsetWidth;
        var h = video.offsetHeight;

        // 同じサイズをcanvasに指定
        canvas.setAttribute("width", w);
        canvas.setAttribute("height", h);

        // canvasにコピー
        ctx.drawImage(video, 0, 0, w, h);

        imageData = canvas.toDataURL('image/png');
        var base64Data = imageData.replace(/^data:image\/png;base64,/, "");

        var txt = $('#txt').val();

        // サーバーに送信
        $.ajax({
            type: 'POST',
            url: 'upload',  // サーバー側のurl
            data: {
                "imgurl": base64Data, "prompt": encodeURIComponent(txt)
            },
            success: function(response) {
                // サーバーからの返答が変数responseに入っている
                $('#answer').html(response);  // サーバーからの説明を表示

                // ギャラリーに画像と説明を追加
                var galleryItem = document.createElement('div');
                galleryItem.classList.add('gallery-item');  // ギャラリーアイテムのクラスを追加

                var newImage = document.createElement('img');
                newImage.src = imageData;  // 画像を設定

                var descDiv = document.createElement('div');
                descDiv.classList.add('description');
                descDiv.textContent = response;  // サーバーから返された説明を設定

                galleryItem.appendChild(newImage);  // 画像をギャラリーアイテムに追加
                galleryItem.appendChild(descDiv);   // 説明をギャラリーアイテムに追加

                $('#gallery').append(galleryItem);  // ギャラリーにアイテムを追加
            },
            error: function() {
                alert('失敗しました');
            }
        });
    });

    // 画像を保存する処理
    $('#save').on('click', function() {
        if (imageData) {
            var link = document.createElement('a');
            link.href = imageData;
            link.download = 'captured_image.png';  // 保存するファイル名
            link.click();  // リンクをクリックしてダウンロード
        } else {
            alert('まず画像を撮影してください');
        }
    });

</script>

</body>
</html>
